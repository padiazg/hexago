{{/*
Template: project/http_server_fiber.go
Description: HTTP server implementation using Fiber v2 framework
Variables:
  - Year: string - Copyright year
  - Author: string - Author name
  - ProjectName: string - Project name
  - ModuleName: string - Go module name
  - AdapterInboundDir: string - primary or driver
  - AdapterOutboundDir: string - secondary or driven
  - CoreLogic: string - services or usecases
  - WithObservability: bool - include observability support
*/}}
/*
Copyright © {{.Year}} {{.Author}}
*/
// Package httpserver provides the HTTP server implementation using Fiber.
//
// This is a {{if eq .AdapterStyle "driver-driven"}}DRIVER{{else}}PRIMARY{{end}} adapter (inbound).
// It receives HTTP requests and delegates to core services.
//
// Allowed imports:
//   - internal/core/ports/inbound (interfaces, if using explicit ports)
//   - internal/core/{{.CoreLogic}} (business logic)
//   - internal/config
//   - pkg/logger
//   - Fiber framework
//
// Forbidden:
//   - internal/adapters/{{.AdapterOutboundDir}}/* (outbound adapters — use ports instead)
package httpserver

import (
	"context"
	"fmt"

	"github.com/gofiber/fiber/v2"
	"{{.ModuleName}}/internal/config"
	"{{.ModuleName}}/pkg/logger"
	srv "{{.ModuleName}}/pkg/server"
{{- if .WithObservability}}
	"{{.ModuleName}}/internal/observability"
{{- end}}
)

var _ srv.Server = (*server)(nil)

// server is the unexported Fiber-backed implementation of Server.
type server struct {
	app *fiber.App
	cfg *config.Config
	log logger.Logger
{{- if .WithObservability}}
	metrics *observability.PrometheusMetrics
{{- end}}
}

// New creates and configures a new Fiber HTTP server.
// Middleware and routes are wired here, keeping cmd/run.go framework-agnostic.
func New(cfg *config.Config, log logger.Logger{{if .WithObservability}}, metrics *observability.PrometheusMetrics{{end}}) srv.Server {
	app := fiber.New(fiber.Config{
		DisableStartupMessage: true,
	})

	s := &server{
		app: app,
		cfg: cfg,
		log: log,
{{- if .WithObservability}}
		metrics: metrics,
{{- end}}
	}

	s.setupRoutes()
	return s
}

// Run starts the HTTP server in a non-blocking goroutine.
func (s *server) Run(errChan chan<- error) {
	go func() {
		s.log.Info("Server listening on port %d", s.cfg.Server.Port)
		if err := s.app.Listen(fmt.Sprintf(":%d", s.cfg.Server.Port)); err != nil {
			errChan <- err
		}
	}()
}

// Stop gracefully shuts down the Fiber server using the context deadline.
func (s *server) Stop(ctx context.Context) error {
	return s.app.ShutdownWithContext(ctx)
}

// setupRoutes registers all HTTP routes on the Fiber app.
func (s *server) setupRoutes() {
	// Lightweight API health check (distinct from /health on the observability server)
	s.app.Get("/ping", func(c *fiber.Ctx) error {
		return c.JSON(fiber.Map{
			"status":  "healthy",
			"service": "{{.ProjectName}}",
		})
	})

	// TODO: Add your routes here
	// Example:
	// api := s.app.Group("/api/v1")
	// api.Get("/users", handlers.ListUsers)
	// api.Post("/users", handlers.CreateUser)
}
